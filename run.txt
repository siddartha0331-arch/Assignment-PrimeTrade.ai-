import pandas as pd
import numpy as np
import argparse
import yaml
import json
import time
import os

def main():
  parser= argparse.ArgumentParser()
  parser.add_argument('--input',required =True,help='input Csv FIle')
  parser.add_argument('--config',required =True,help='Config YAML file')
  parser.add_argument('--output',required =True,help='Output Json File')
  parser.add_argument('--log-file',required =True,help='log FIle')
  args=parser.parse_args()

  start_time=time.time()




  #load config
  try:
    if not os.path.exists(args.config):
      raise FileNotFoundError(f"config file not found:{args.config}")
    
    try:
      with open(args.config,'r')as f:
        config=yaml.safe.load(f)
      
    except yaml.YAMLError as e:
      raise ValueError(f"Invalid YAML format in config file:{e}")

    requires_fields = ['seed','window','version']
    for field in required_fields:
      if field not in config:
        raise ValueError(f"Missing requires field in config: {field}")
    
    seed=config['seed']
    window=config['window']
    version=config['version']
    np.random.seed(seed)


    #Input file
    if not os.path.exists(args.input):
      raise FileNotFoundError(f"Input file not found:{args.input}")

    try:
      df=pd.read_csv(args.input)
    except pd.errors.EmptyDataError:
      raise ValueError(f"Input file is empty:{args.input}")
    except pd.errors.ParserError as e:
      raise ValueError(f"Invalid parsing CSV:{e}")
    exvept Exception as e:
      raise ValueError(f"Error reading csv:{e}")

    if len(df)==0:
      raise ValueError(f"CSV file contains no data rows")

    if 'close' not in df.columns:
      raise ValueError(f"Missing required column 'close' in csv")

    df['rolling_mean']=df['close'].rolling(window=window).mean()
    df['signal']=(df['close']>df['rolling_mean']).astype(int)

    signal_rate=df['signal'].mean()
    rows_processed=len(df)
    latency_ms=int((time.time() - start_time)*1000)


    output = {
            "version": version,
            "rows_processed": rows_processed,
            "metric": "signal_rate",
            "value": round(signal_rate, 4),
            "latency_ms": latency_ms,
            "seed": seed,
            "status": "success"
        }

    with open(args.output,'w')as f:
      json.dump(output,f, indent=2)

    print(json.dumps(output,indent=2))

  except FileNotFoundError as e:
    output={
        "version":config.get('version','v1') if 'config' in locals() else 'v1',
        "status":"error",
        "error_message": str(e)
    }
    with open(args.output,'w')as f:
      json.dump(output,f,indent=2)
    print(json.dumps(output,indent=2))

  except ValueError as e:
    output={
        "version":config.get('version','v1') if 'config' in locals() else 'v1',
        "status":"error",
        "error_message": str(e)
    }

    with open(args.output,'w')as f:
      json.dump(output,f,indent=2)
    print(json.dumps(output,indent=2))


  except Exception as e:
    output={
        "version":config.get('version','v1') if 'config' in locals() else 'v1',
        "status":"error",
        "error_message": f"Unexpected error:{str(e)}"
    }
    with open(args.output,'w')as f:
      json.dump(output,f,indent=2)
    print(json.dumps(output,indent=2))

if __name__ == "__main__":
  main()